<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Foot Piano Prototype</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { position: absolute; top: 0; left: 0; z-index: 1; }
    video { position: absolute; top: 0; left: 0; transform: scaleX(-1); z-index: 0; opacity: 0.7; }
    button { position: absolute; top: 20px; left: 20px; z-index: 2; font-size: 18px; padding: 10px 20px; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <video id="video" width="1280" height="720" autoplay muted playsinline></video>
  <canvas id="canvas" width="1280" height="720"></canvas>
  <button id="startButton">啟動鏡頭</button>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469242/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');

    const pianoKeys = [
      { note: 'C', x: 100 },
      { note: 'D', x: 200 },
      { note: 'E', x: 300 },
      { note: 'F', x: 400 },
      { note: 'G', x: 500 },
      { note: 'A', x: 600 },
      { note: 'B', x: 700 },
      { note: 'C5', x: 800 }
    ];

    const audios = {};
    pianoKeys.forEach(key => {
      audios[key.note] = new Audio(`https://cdn.jsdelivr.net/gh/johnyman999/piano-notes/${key.note}.mp3`);
    });

    function drawPianoKeys() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pianoKeys.forEach(key => {
        ctx.fillStyle = '#fff';
        ctx.fillRect(key.x, 600, 80, 100);
        ctx.fillStyle = '#000';
        ctx.font = '20px sans-serif';
        ctx.fillText(key.note, key.x + 25, 660);
      });
    }

    function checkKeyHit(x, y) {
      if (y < 600 || y > 700) return null;
      return pianoKeys.find(key => x >= key.x && x <= key.x + 80);
    }

    const pose = new Pose({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 0,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    let lastPlayed = '';

    pose.onResults(results => {
      drawPianoKeys();
      if (results.poseLandmarks) {
        const foot = results.poseLandmarks[31]; // right heel
        const x = foot.x * canvas.width;
        const y = foot.y * canvas.height;

        ctx.beginPath();
        ctx.arc(x, y, 15, 0, 2 * Math.PI);
        ctx.fillStyle = 'red';
        ctx.fill();

        const key = checkKeyHit(x, y);
        if (key && key.note !== lastPlayed) {
          audios[key.note].currentTime = 0;
          audios[key.note].play();
          lastPlayed = key.note;
          setTimeout(() => { lastPlayed = ''; }, 300);
        }
      }
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await pose.send({ image: video });
      },
      width: 1280,
      height: 720
    });

    startButton.addEventListener('click', () => {
      camera.start();
      startButton.style.display = 'none';
    });
  </script>
</body>
</html>
