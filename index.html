<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Foot Piano V5.3小星星</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    video { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: 0; }
    canvas { position: absolute; top: 0; left: 0; z-index: 1; }
    button { position: absolute; top: 20px; left: 20px; z-index: 2; padding: 10px 20px; font-size: 18px; border: none; border-radius: 6px; background: #28a745; color: #fff; cursor: pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <button id="startBtn">啟動手掌偵測</button>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const whiteKeyNotes = ['F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5','D5','E5'];
  const simpleNumbers = ['-4','-5','-6','-7','1','2','3','4','5','6','7','+1','+2','+3'];
  const audios = {};
  whiteKeyNotes.forEach((note, i) => {
    audios[i] = new Audio(`./sounds/${note}.mp3`);
  });

  const hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
  hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  let keyParams = null;
  let currentNote = 0;
  let isKeyPressed = false;
  let pressTimeout = null;
  let readyForNextTouch = true;
  let lastTouchedIndex = null;

  // 小星星音符序列 (使用正確 index)
  const melody = [
    4, 4, 8, 8, 9, 9, 8,
    7, 7, 6, 6, 5, 5, 4,
    8, 8, 7, 7, 6, 6, 5,
    8, 8, 7, 7, 6, 6, 5,
    4, 4, 8, 8, 9, 9, 8,
    7, 7, 6, 6, 5, 5, 4
  ];

  function drawPiano(ctx, W, H) {
    const tot = whiteKeyNotes.length;
    const wW = W / tot;
    const baseH = H / 3;
    const wH = baseH * 1.4;
    const vO = (H - wH) / 2;

    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(0, vO - 5, W, 10);

    for (let i = 0; i < tot; i++) {
      const x = i * wW;
      const isActive = i === melody[currentNote];
      const y = (isActive && isKeyPressed) ? vO - 20 : (isActive ? vO - 10 : vO);
      ctx.fillStyle = isActive ? 'rgba(255,255,0,0.9)' : 'rgba(255,255,255,0.8)';
      ctx.fillRect(x, y, wW, wH);
      ctx.strokeStyle = 'rgba(0,0,0,1)';
      ctx.lineWidth = 4.5;
      ctx.strokeRect(x, y, wW, wH);
      ctx.save();
      ctx.fillStyle = '#cc0000';
      ctx.font = 'bold 56px Arial';
      ctx.textAlign = 'center';
      ctx.translate(x + wW / 2, y + wH - 20);
      ctx.scale(-1, 1);
      ctx.fillText(simpleNumbers[i], 0, 0);
      ctx.restore();
    }

    return { whiteKeyWidth: wW, whiteKeyXOffset: 0, whiteKeyY: vO, whiteKeyHeight: wH };
  }

  hands.onResults(results => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    keyParams = drawPiano(ctx, canvas.width, canvas.height);

    if (results.multiHandLandmarks && readyForNextTouch) {
      results.multiHandLandmarks.forEach(lm => {
        const pt = lm[8];
        const x = pt.x * canvas.width;
        const y = pt.y * canvas.height;
        const i = Math.floor((x - keyParams.whiteKeyXOffset) / keyParams.whiteKeyWidth);
        const withinY = y > keyParams.whiteKeyY && y < keyParams.whiteKeyY + keyParams.whiteKeyHeight;

        const targetIndex = melody[currentNote];
        if (i === targetIndex && withinY) {
          if (lastTouchedIndex !== i) {
            isKeyPressed = true;
            readyForNextTouch = false;
            lastTouchedIndex = i;
            audios[targetIndex]?.currentTime = 0;
            audios[targetIndex]?.play();

            clearTimeout(pressTimeout);
            pressTimeout = setTimeout(() => {
              currentNote = (currentNote + 1) % melody.length;
              isKeyPressed = false;
              readyForNextTouch = true;
              lastTouchedIndex = null;
            }, 400);
          }
        }
      });
    }

    ctx.restore();
  });

  startBtn.addEventListener('click', async () => {
    try {
      const camera = new Camera(video, {
        onFrame: async () => await hands.send({ image: video }),
        width: 1280,
        height: 720
      });
      await camera.start();
      startBtn.style.display = 'none';
    } catch (err) {
      alert('相機啟動失敗：' + err.message);
      console.error(err);
    }
  });
});
</script>
</body>
</html>
